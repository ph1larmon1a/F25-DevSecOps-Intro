# Lab 2 ‚Äî Threat Modeling (Threat Dragon + Threagile)

![difficulty](https://img.shields.io/badge/difficulty-beginner‚Äìintermediate-yellow)
![topic](https://img.shields.io/badge/topic-Threat%20Modeling%20%26%20Security%20Requirements-blue)
![points](https://img.shields.io/badge/points-10-orange)

> **Goal:** Model the **OWASP Juice Shop `bkimminich/juice-shop:19.0.0`** deployment, identify top risks, and produce both a **diagram-first** and an **automation-first** threat model.  
> **Deliverable:** A PR from `feature/lab2` with a Threat Dragon model + Threagile outputs and a short risk summary.

---

## Overview

In this lab you will practice:

* Building a **data flow diagram (DFD)** and capturing threats with **OWASP Threat Dragon** (supports STRIDE and auto-suggests threats via a rule engine).
* Creating an **as-code** model with **Threagile** to automatically generate a **risk report + diagrams** from YAML (great for CI).

> Keep using the Juice Shop from Lab 1 (`:19.0.0`).

---

## Tasks

### Task 1 ‚Äî Threagile model & automated report (2 pts)

**Objective:** Use the provided Threagile model to generate a PDF report + diagrams and document the results in `labs/submission2.md`.

1. **Use the provided YAML**

- `labs/lab2/threagile-model.yaml` is provided. Do not restructure it for this task.
- You may make a small change for the ‚ÄúDelta Run‚Äù step (e.g., switch one link to HTTPS).

2. **Generate outputs (risks + diagrams + PDF)**

Run Threagile against the model and write all artifacts into `lab2`:

  ```bash
  docker run --rm -it -v "$(pwd)":/app/work threagile/threagile \
    -verbose \
    -model /app/work/labs/labs/lab2/threagile-model.yaml \
    -output /app/work/labs/lab2 \
    -generate-risks-excel=false \
    -generate-tags-excel=false
  ```

What you get in `labs/lab2/`:

- `report.pdf` ‚Äî full PDF report (includes diagrams) generated by default.
- Diagrams: data-flow & data-asset diagrams (PNG).
- Risk outputs: `risks.json` and also `stats.json`, `technical-assets.json`.

3. **Create `labs/submission2.md`**

Include the following sections:

- Top 5 Risks (from `labs/lab2/risks.json`): create a table with columns ‚Äî Severity, Category, Asset, Likelihood, Impact.
  - Ranking: Sort risks by these weights to pick the Top 5:
    - Severity order: critical (5) > elevated (4) > high (3) > medium (2) > low (1)
    - Likelihood order: very-likely (4) > likely (3) > possible (2) > unlikely (1)
    - Impact order: high (3) > medium (2) > low (1)
    - Composite score = Severity*100 + Likelihood*10 + Impact. Sort descending; use score to break ties.
  - Practical way:
    - Manual read: open `labs/lab2/risks.json`, scan fields `severity`, `exploitation_likelihood`, `exploitation_impact`, `category`, `most_relevant_technical_asset`, apply the weights above, and pick the top 5.
- **Delta Run**: change one thing in the YAML (e.g., set Reverse Proxy ‚Üí App link to HTTPS), re-run, and paste a before/after of the relevant counts (e.g., unencrypted-communication dropped). Add a one-sentence reason why.

4. **Deliverables**

Commit/push:

- `labs/lab2/threagile-model.yaml`
- `labs/lab2/*diagram*.png` (at least the data-flow diagram)
- `labs/submission2.md` (the write-up described above)

5. **Quality checklist (pass/fail hints)**

- Report opens and diagrams render.
- Top 5 risks table present and legible; ties broken sensibly.
- Stats snapshot included (from `stats.json`).
- Clear overlap/difference vs Threat Dragon.
- Delta Run shows before/after evidence and a short explanation.

> Resources: Threagile site (auto risk rules, diagrams, CI-friendly), CLI usage (Docker examples), sample outputs. ([threagile.io][3], [GitHub][6], [juanvvc.github.io][4])
---

### Task 2 ‚Äî Threat Dragon Web Model (4 pts)

**Objective:** Create a diagram-based threat model of your local Juice Shop setup using the web UI at `threatdragon.com`, and extract the top 5 risks.

1. **Use the Threat Dragon web UI**
   - Go to `threatdragon.com` ‚Üí New Model (GitHub login required).
   - Select a repo/branch where models are stored (optional).
   - Provide metadata: title = ‚ÄúJuice Shop Lab‚Äù, owner = your GitHub handle.
   - Add a diagram: place trust boundaries, actors, components, and flows.
   - Assign STRIDE categories to each element/flow (via the properties pane).
   - Run the rule engine and review auto-generated threats.
   - Triage: keep, edit, or drop threats. Add mitigation notes (e.g., TLS via proxy, authz on sensitive routes, rate limiting).

2. **Model the deployment (minimum elements)**
   - **Actors:** User (Browser), Attacker (Internet)
   - **Components:** Reverse Proxy (optional), Juice Shop Container (`:19.0.0`), Persistent Storage (e.g., container volume), Email/SMS provider (if configured)
   - **Flows:**
     - `HTTP 3000/tcp` Browser ‚Üî Juice Shop (or Browser ‚Üî Proxy ‚Üî Juice Shop)
     - Outbound flows from Juice Shop (Email/SMS API, webhook, etc.)
     - Persistent storage ‚Üî Juice Shop
   - **Trust Boundaries:** Internet ‚á¢ Host; Host ‚á¢ Container Network

3. **Folder & files**
   - Create in your repo:
     - `labs/lab2/threat-dragon.json` ‚Äî download/export the JSON model from the web UI.
     - `labs/lab2/dfd.png` ‚Äî export your diagram as PNG/SVG.
     - `labs/lab2/THREATS.md` ‚Äî markdown summary of your top risks.

4. **Write `labs/lab2/THREATS.md`**
   - **Top 5 risks:** one-liners with STRIDE tags (e.g., ‚ÄúInjection [Tampering] ‚Äî unsanitized input can corrupt DB‚Äù).
   - Cross-check vs Threagile: 2 overlaps + 1 difference (one-liners).

> Resources: Threat Dragon docs & project page (DFDs, STRIDE, rule engine, desktop/web options).

---

### Bonus ‚Äî GitHub Social Interactions (optional)

**Objective**: Explore GitHub‚Äôs social features and how they support collaboration.

1. Star the course repository.  
2. Follow your professor, TAs, and at least 3 classmates.
3. In `labs/submission2.md`, add 1‚Äì2 sentences on why stars/follows matter in open source and team projects.

---

### Acceptance Criteria

* ‚úÖ `labs/lab2/threat-dragon.json` exported and `labs/lab2/dfd.png` exported (diagram shows actors, Juice Shop container, flows, and trust boundaries).
* ‚úÖ `labs/lab2/THREATS.md` lists **Top 5** STRIDE-tagged risks.
* ‚úÖ `labs/lab2/threagile-model.yaml` models the same architecture at a reasonable fidelity.
* ‚úÖ `labs/lab2/*diagram*.png` includes at least the data-flow diagram.
* ‚úÖ `labs/submission2.md` includes: Artifacts list, Top 5 risks table, Stats snapshot, 2 overlaps + 1 difference Threagile vs Threat Dragon, and a Delta Run with before/after evidence.
* ‚úÖ PR from `feature/lab2` ‚Üí `main` is open with artifacts attached/linked in the description.

---

## How to Submit

1. Create `feature/lab2`, commit the new files, push, and open a PR.
2. In the PR description, fill your template sections and include:

   ```text
   - [x] Task 1: Threagile YAML + report + diagrams + submission2.md
   - [x] Task 2: Threat Dragon model + THREATS.md
   ```

---

## Rubric (10 pts)

| Criterion                                                          | Points |
| ------------------------------------------------------------------ | -----: |
| Task 1 ‚Äî Threat Dragon DFD + **Top 5** risks in `THREATS.md`       |  **6** |
| Task 2 ‚Äî Threagile YAML + generated report/diagrams + submission2  |  **4** |
| **Total**                                                          | **10** |

---

## Hints

> üß≠ **Model the lab reality.** Use exactly the architecture you‚Äôre running from Lab 1 (localhost, optional proxy).
> üß† **Threat Dragon tip:** Start with STRIDE per **flow** first (S/T/I for auth, R/E for data tampering/DoS), then per **asset**. The tool‚Äôs rule engine can suggest threats you can triage. ([OWASP][5])
> ‚öôÔ∏è **Threagile flags:** You can generate a stub (`-create-stub-model`), list enums (`-list-types`), and run analysis with `-model ... -output ...`; it emits report/DFDs and risk exports‚Äîhandy for CI. ([Go Packages][1], [Kali Linux Tutorials][2])
> üìë **Keep it short:** One-page summaries beat walls of text‚Äîuse bullets and link the artifacts.
> üîÅ **Consistent IDs:** Use the same risk names/IDs across both tasks where they overlap‚Äîthis helps later when we create CI gates and dashboards.

---

[1]: https://pkg.go.dev/github.com/threagile/threagile?utm_source=chatgpt.com "threagile command - github.com/threagile/threagile - Go ... - Go Packages"
[2]: https://kalilinuxtutorials.com/threagile/?utm_source=chatgpt.com "Threagile : Agile Threat Modeling Toolkit 2020!Kalilinuxtutorials"
[3]: https://threagile.io/?utm_source=chatgpt.com "Threagile ‚Äî Agile Threat Modeling Toolkit"
[4]: https://juanvvc.github.io/securecoding/images/threatmod/threagile/report.pdf?utm_source=chatgpt.com "Threat Model Report: Some Example Application"
[5]: https://owasp.org/www-project-threat-dragon/?utm_source=chatgpt.com "OWASP Threat Dragon"
[6]: https://github.com/Threagile/threagile "GitHub - Threagile/threagile: Agile Threat Modeling Toolkit"
[7]: https://github.com/Threagile/threagile/blob/master/demo/example/threagile.yaml "threagile/demo/example/threagile.yaml at master - GitHub"
